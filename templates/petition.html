<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sign Petition</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#eef2f8; margin:0; padding:20px; }
    .wrap{ max-width:920px; margin:0 auto; background:white; padding:18px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.06) }
    h2{ margin-top:0; }
    form > div{ margin-bottom:10px; }
    label{ display:block; margin-bottom:6px; font-weight:600; }
    input[type="text"], textarea, select { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
    button { padding:10px 16px; border:none; background:#1f8feb; color:white; border-radius:6px; cursor:pointer; }
    .stats{ margin-top:14px; padding:12px; background:#f3f7fb; border-radius:6px; }
    .cards{ margin-top:14px; display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
    .card{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.04); }
    .small{ color:#666; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/" style="text-decoration:none;color:#333">&#8592; back</a>
    <h2>Sign the Petition</h2>
    <p class="small">Please enter AFN, Year, Branch and your message/reason for signing.</p>

    <form id="petitionForm">
      <div>
        <label>AFN number</label>
        <input type="text" id="afn" placeholder="AFN12345" required />
      </div>
      <div style="display:flex; gap:10px;">
        <div style="flex:1">
          <label>Year</label>
          <select id="year">
            <option value="">Select year</option>
            <option>1st</option>
            <option>2nd</option>
            <option>3rd</option>
            <option>4th</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Branch</label>
          <input type="text" id="branch" placeholder="CSE / ECE / ME" required />
        </div>
      </div>

      <div>
        <label>Why are you signing? (short)</label>
        <textarea id="comment" rows="4" placeholder="I support this petition because..." required></textarea>
      </div>

      <div>
        <button type="button" id="submitBtn">Sign Petition</button>
      </div>
    </form>

    <div class="stats" id="counts">
      Loading counts...
    </div>

    <h3 style="margin-top:18px">Students who signed / submitted</h3>
    <div class="cards" id="cards">
      Loading records...
    </div>
  </div>

  <script>
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.addEventListener("click", async () => {
      const afn = document.getElementById("afn").value.trim();
      const year = document.getElementById("year").value.trim();
      const branch = document.getElementById("branch").value.trim();
      const comment = document.getElementById("comment").value.trim();
      if (!afn || !year || !branch || !comment) {
        alert("Please fill all fields.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        const res = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ afn, year, branch, comment, form_type: "petition" })
        });
        const data = await res.json();
        if (data.success) {
          // reset
          document.getElementById("petitionForm").reset();
          await refreshData();
          alert("Thank you — your petition signature is recorded.");
        } else {
          alert("Error: " + (data.error || "unknown"));
        }
      } catch (err) {
        console.error(err);
        alert("Network error.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Sign Petition";
      }
    });

    async function refreshData(){
      // counts
      try {
        const c = await fetch("/api/counts");
        const jc = await c.json();
        if (jc.success) {
          document.getElementById("counts").innerHTML = `
            <strong>Total entries:</strong> ${jc.total} —
            <small>Petitions: ${jc.petitions}, Demands: ${jc.demands}</small>
          `;
        } else {
          document.getElementById("counts").textContent = "Could not load counts.";
        }
      } catch(e) {
        document.getElementById("counts").textContent = "Error loading counts.";
      }

      // records
      try {
        const r = await fetch("/api/records");
        const jr = await r.json();
        const cards = document.getElementById("cards");
        if (jr.success) {
          if (jr.records.length === 0) {
            cards.innerHTML = "<div class='small'>No records yet.</div>";
            return;
          }
          cards.innerHTML = jr.records.map(rec => `
            <div class="card">
              <div><strong>${rec.afn}</strong> — <span class="small">${rec.year} / ${rec.branch}</span></div>
              <div style="margin-top:8px">${escapeHtml(rec.comment)}</div>
              <div class="small" style="margin-top:8px">Type: ${rec.form_type} • ${new Date(rec.created_at).toLocaleString()}</div>
            </div>
          `).join("");
        } else {
          cards.innerHTML = "<div class='small'>Could not load records.</div>";
        }
      } catch(e) {
        document.getElementById("cards").innerHTML = "<div class='small'>Error loading records.</div>";
      }
    }

    // small escape helper
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // initial load
    refreshData();
    // poll every 15s to keep live (optional)
    setInterval(refreshData, 15000);
  </script>
</body>
</html>